(function(){"use strict";function o(a,t,s,e,u,f,d,k){var i=typeof a=="function"?a.options:a;return t&&(i.render=t,i.staticRenderFns=s,i._compiled=!0),{exports:a,options:i}}const n={props:{stats:Object},data(){return{isLoading:!1,isCreatingBackup:!1,isLoadingBackups:!1,isLoadingFtpStats:!1,backups:[],ftpWarning:{show:!1,message:"",isPersistent:!1},ftpStats:null,ftpStatsError:null}},created(){this.loadBackups(),this.checkFtpSettings()},methods:{async loadBackups(){this.isLoadingBackups=!0;try{const a=await this.$api.get("ftp-backup/backups");a.status==="success"&&a.data?this.backups=a.data.map(t=>({id:t.filename,text:t.filename,info:new Date(t.modified*1e3).toLocaleString()+" - "+this.formatSize(t.size),url:t.downloadUrl,icon:"archive"})):this.backups=[],a.status==="success"&&a.stats&&(this.stats=a.stats)}catch{window.panel.notification.error("Failed to load backups"),this.backups=[]}finally{this.isLoadingBackups=!1}},async createBackup(){this.isCreatingBackup=!0;try{const a=await this.$api.post("ftp-backup/create");if(a.status==="success")window.panel.notification.success(a.message),this.loadBackups(),a.data&&a.data.ftpResult&&!a.data.ftpResult.uploaded&&!a.data.ftpResult.disabled?this.showFtpWarning(a.data.ftpResult.message||"FTP upload failed",!0):this.dismissWarning();else{const t=a.message||"Failed to create backup";window.panel.notification.error(t),(t.toLowerCase().includes("ftp")||t.toLowerCase().includes("sftp"))&&this.showFtpWarning(t,!0)}}catch(a){const t=a.message||"Failed to create backup";window.panel.notification.error(t),console.error("Backup creation error:",a),this.showFtpWarning("Error: "+t,!0)}finally{this.isCreatingBackup=!1}},showSettingsInfo(){this.$refs.settingsDialog.open()},downloadBackup(a){window.open(a.url,"_blank")},showFtpServerStats(){this.$refs.ftpStatsDialog.open(),this.loadFtpServerStats()},async loadFtpServerStats(){this.isLoadingFtpStats=!0,this.ftpStatsError=null;try{const a=await this.$api.get("ftp-backup/ftp-stats");a.status==="success"&&a.data?this.ftpStats=a.data:(this.ftpStatsError=a.message||"Failed to load FTP server stats",this.ftpStats=null)}catch{this.ftpStatsError="Failed to connect to FTP server",this.ftpStats=null}finally{this.isLoadingFtpStats=!1}},showFtpWarning(a,t=!1){this.ftpWarning={show:!0,message:a,isPersistent:t},t&&sessionStorage.setItem("ftpBackupWarning",JSON.stringify(this.ftpWarning))},dismissWarning(){this.ftpWarning.show=!1,sessionStorage.removeItem("ftpBackupWarning")},checkFtpSettings(){const a=sessionStorage.getItem("ftpBackupWarning");if(a)try{this.ftpWarning=JSON.parse(a)}catch{sessionStorage.removeItem("ftpBackupWarning")}this.$api.get("ftp-backup/settings-status").then(t=>{t.status==="success"&&(t.data.ftpEnabled===!1?this.showFtpWarning("FTP upload is disabled. Backups will be created locally only.",!0):t.data.configured?this.dismissWarning():this.showFtpWarning("FTP settings are not configured. Backups will be created locally only.",!0))}).catch(()=>{})},formatSize(a){const t=["B","KB","MB","GB","TB"];let s=a,e=0;for(;s>=1024&&e<t.length-1;)s/=1024,e++;return`${s.toFixed(2)} ${t[e]}`}}};var p=function(){var t=this,s=t._self._c;return s("k-panel-inside",{staticClass:"k-ftp-backup-view"},[t.ftpWarning.show?s("div",{staticClass:"k-ftp-backup-view-warning"},[s("k-box",{staticClass:"k-ftp-backup-view-warning-box",attrs:{theme:"negative"}},[s("k-icon",{attrs:{type:"alert"}}),s("span",[t._v(t._s(t.ftpWarning.message))]),s("k-button",{attrs:{icon:"settings"},on:{click:t.showSettingsInfo}}),s("k-button",{attrs:{icon:"cancel"},on:{click:t.dismissWarning}})],1)],1):t._e(),s("div",{staticClass:"k-ftp-backup-view-stats"},[s("div",{staticClass:"k-ftp-backup-view-stats-card"},[s("h3",[t._v("Total Backups")]),s("p",[t._v(t._s(t.stats.count))])]),s("div",{staticClass:"k-ftp-backup-view-stats-card"},[s("h3",[t._v("Total Size")]),s("p",[t._v(t._s(t.stats.formattedTotalSize))])]),s("div",{staticClass:"k-ftp-backup-view-stats-card"},[s("h3",[t._v("Latest Backup")]),t.stats.latestBackup?s("p",[t._v(t._s(t.stats.latestBackup.formattedDate))]):s("p",[t._v("None")]),t.stats.latestBackup?s("div",{staticClass:"k-ftp-backup-view-stats-card-latest"},[t._v(" "+t._s(t.stats.latestBackup.filename)+" ")]):t._e()])]),s("div",{staticClass:"k-ftp-backup-view-section"},[s("div",{staticClass:"k-ftp-backup-view-actions"},[s("k-button-group",[s("k-button",{attrs:{icon:"upload",disabled:t.isLoading||t.isCreatingBackup,progress:t.isCreatingBackup},on:{click:t.createBackup}},[t._v(" Create Backup Now ")]),s("k-button",{attrs:{icon:"refresh",disabled:t.isLoading||t.isCreatingBackup,progress:t.isLoadingBackups},on:{click:t.loadBackups}}),s("k-button",{attrs:{icon:"info"},on:{click:t.showSettingsInfo}}),s("k-button",{attrs:{icon:"server",disabled:t.isLoading||t.isCreatingBackup||t.isLoadingFtpStats,progress:t.isLoadingFtpStats,title:"Show FTP Server Stats"},on:{click:t.showFtpServerStats}})],1)],1)]),s("div",{staticClass:"k-tab-content"},[t.isLoadingBackups?s("div",{staticClass:"k-ftp-backup-view-loading"},[s("k-loader")],1):t.backups.length===0?s("div",{staticClass:"k-ftp-backup-view-backup-list"},[s("div",{staticClass:"k-ftp-backup-view-backup-list-empty"},[t._v(" No backups available ")])]):s("k-collection",{attrs:{items:t.backups,layout:"list"},scopedSlots:t._u([{key:"options",fn:function({item:e}){return[s("k-button",{attrs:{icon:"download"},on:{click:function(u){return t.downloadBackup(e)}}})]}}])})],1),s("k-dialog",{ref:"settingsDialog",attrs:{size:"large"}},[s("div",{staticClass:"k-ftp-backup-dialog-content"},[s("h2",{staticClass:"k-ftp-backup-dialog-title"},[t._v("FTP Backup Settings")]),s("div",{staticClass:"k-ftp-backup-dialog-section"},[s("h3",[t._v("Configuration")]),s("p",[t._v("FTP settings are managed through your site config file.")]),s("p",[t._v("Add the following to your "),s("code",[t._v("site/config/config.php")]),t._v(" file:")]),s("div",{staticClass:"k-ftp-backup-dialog-code"},[s("pre",[t._v(`'tearoom1.kirby-ftp-backup' => [
    'ftpProtocol' => 'ftp', // ftp, ftps or sftp
    'ftpHost' => 'your-ftp-host.com',
    'ftpPort' => 21,
    'ftpUsername' => 'your-username',
    'ftpPassword' => 'your-password',
    'ftpDirectory' => 'backups',
    'ftpPassive' => true,
    'ftpPrivateKey' => '', // for sftp
    'ftpPassphrase' => '' // for sftp
]`)])]),t._v(" Find more about those options in the Readme.md file ")]),s("div",{staticClass:"k-ftp-backup-dialog-section"},[s("h3",[t._v("Automatic Backups")]),s("p",[t._v("For automatic backups, set up a cron job to run:")]),s("div",{staticClass:"k-ftp-backup-dialog-code"},[s("pre",[t._v("php /path/to/site/plugins/kirby-ftp-backup/run.php")])]),s("p",{staticClass:"k-ftp-backup-dialog-hint"},[t._v("Example crontab entry (daily at 2AM):")]),s("div",{staticClass:"k-ftp-backup-dialog-code"},[s("pre",[t._v("0 2 * * * php /path/to/site/plugins/kirby-ftp-backup/run.php")])])])]),s("k-button-group",{attrs:{slot:"footer"},slot:"footer"},[s("k-button",{attrs:{icon:"check"},on:{click:function(e){return t.$refs.settingsDialog.close()}}},[t._v(" Close ")])],1)],1),s("k-dialog",{ref:"ftpStatsDialog",attrs:{button:"close",size:"large",theme:"info"}},[s("k-headline",[t._v("FTP Server Stats")]),t.isLoadingFtpStats?s("div",{staticClass:"k-ftp-backup-dialog-loading"},[s("k-icon",{staticClass:"k-ftp-backup-spinner",attrs:{type:"loader"}}),s("span",[t._v("Loading FTP server stats...")])],1):t.ftpStatsError?s("div",{staticClass:"k-ftp-backup-dialog-error"},[s("k-box",{attrs:{theme:"negative"}},[t._v(" "+t._s(t.ftpStatsError)+" ")])],1):t.ftpStats?s("div",{staticClass:"k-ftp-backup-view-server-stats"},[s("div",{staticClass:"k-ftp-backup-view-stats"},[s("div",{staticClass:"k-ftp-backup-view-stats-card"},[s("h3",[t._v("Files on Server")]),s("p",[t._v(t._s(t.ftpStats.count))])]),s("div",{staticClass:"k-ftp-backup-view-stats-card"},[s("h3",[t._v("Total Size")]),s("p",[t._v(t._s(t.ftpStats.formattedTotalSize))])]),s("div",{staticClass:"k-ftp-backup-view-stats-card"},[s("h3",[t._v("Latest Backup")]),s("p",[t._v(t._s(t.ftpStats.latestModified))])])]),s("div",{staticClass:"k-ftp-backup-dialog-section"},[s("h3",[t._v("Files on FTP Server")]),t.ftpStats.files&&t.ftpStats.files.length>0?s("div",[s("table",{staticClass:"k-ftp-backup-files-table"},[s("thead",[s("tr",[s("th",[t._v("Filename")]),s("th",[t._v("Size")]),s("th",[t._v("Date")])])]),s("tbody",t._l(t.ftpStats.files,function(e){return s("tr",{key:e.filename},[s("td",[t._v(t._s(e.filename))]),s("td",[t._v(t._s(e.formattedSize))]),s("td",[t._v(t._s(e.formattedDate))])])}),0)])]):s("div",{staticClass:"k-ftp-backup-view-backup-list-empty"},[t._v(" No backups available on FTP server ")])])]):t._e()],1)],1)},r=[],c=o(n,p,r);const l=c.exports;panel.plugin("tearoom1/kirby-ftp-backup",{components:{"ftp-backup-view":l}})})();
